name: CI/CD Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runsself-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build

      - name: Build Docker image
        run: |
          docker build -t research-app:${{ github.sha }} .
          docker build -t research-app:latest .

      - name: Test Docker container
        run: |
          # Stop existing container if running
          docker stop research-app-test || true
          docker rm research-app-test || true
          
          # Run new container for testing
          docker run -d --name research-app-test -p 3001:3000 research-app:latest
          
          # Wait for container to start
          sleep 10
          
          # Test if the application is responding
          curl -f http://localhost:3001 || exit 1
          
          # Clean up test container
          docker stop research-app-test
          docker rm research-app-test

  deploy:
    runs-on: self-hosted
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and deploy Docker container
        run: |
          echo "🏗️ Building production Docker image..."
          docker build -t research-app:production .
          
          echo "🚀 Deploying to local production..."
          
          # Stop existing production container if running
          docker stop research-app || true
          docker rm research-app || true
          
          # Run new production container
          docker run -d --name research-app -p 3000:3000 --restart unless-stopped research-app:production
          
          echo "✅ Deployment complete!"
          echo "🌐 Application available at http://localhost:3000"

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://localhost:3000 || exit 1
          echo "✅ Deployment verification successful!"