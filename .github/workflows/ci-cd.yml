name: CI/CD Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build

      - name: Build Docker image
        run: |
          docker build -t research-app:${{ github.sha }} .
          docker build -t research-app:latest .

      - name: Test Docker container
        shell: pwsh
        run: |
          # Stop existing container if running
          docker stop research-app-test 2>$null || $true
          docker rm research-app-test 2>$null || $true
          
          # Run new container for testing
          docker run -d --name research-app-test -p 3001:3000 research-app:latest
          
          # Wait for container to start
          Start-Sleep -Seconds 10
          
          # Test if the application is responding (PowerShell equivalent)
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3001" -UseBasicParsing -TimeoutSec 30
            Write-Host "‚úÖ Container test successful - Status: $($response.StatusCode)"
          } catch {
            Write-Error "‚ùå Container test failed: $_"
            docker logs research-app-test
            exit 1
          }
          
          # Clean up test container
          docker stop research-app-test
          docker rm research-app-test

  deploy:
    runs-on: self-hosted
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and deploy Docker container
        shell: pwsh
        run: |
          Write-Host "üèóÔ∏è Building production Docker image..."
          docker build -t research-app:production .
          
          Write-Host "üöÄ Deploying to local production..."
          
          # Stop existing production container if running
          docker stop research-app 2>$null || $true
          docker rm research-app 2>$null || $true
          
          # Run new production container
          docker run -d --name research-app -p 3000:3000 --restart unless-stopped research-app:production
          
          Write-Host "‚úÖ Deployment complete!"
          Write-Host "üåê Application available at http://localhost:3000"

      - name: Verify deployment
        shell: pwsh
        run: |
          Start-Sleep -Seconds 10
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3000" -UseBasicParsing -TimeoutSec 30
            Write-Host "‚úÖ Deployment verification successful - Status: $($response.StatusCode)"
          } catch {
            Write-Error "‚ùå Deployment verification failed: $_"
            docker logs research-app
            exit 1
          }